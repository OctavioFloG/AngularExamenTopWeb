<app-nav></app-nav>

<div class="grades-layout">
  @if (loading) {
    <p class="grades-loading">Cargando calificaciones...</p>
  }
  @else if (errorMsg) {
    <div class="grades-error">
      {{ errorMsg }}
    </div>
  }
  @else if (calificaciones.length > 0) {

    <header class="grades-header">
      <h2>Calificaciones del semestre actual</h2>
      <p>Consulta tus materias y parciales del periodo vigente.</p>
    </header>

    @for (item of calificaciones; track item.periodo?.clave_periodo) {

      <!-- Tarjeta por periodo -->
      <section class="grades-period-card">
        <div class="grades-period-header">
          <div class="period-info">
            <span class="period-label">Periodo</span>
            <h3 class="period-title">
              {{ item.periodo.descripcion_periodo }} 
            </h3>
            <span class="period-code">
              Clave periodo: {{ item.periodo.clave_periodo }}
            </span>
          </div>
          <div class="period-icon">ðŸ“…</div>
        </div>

        <!-- Tarjetas por materia -->
        <div class="materias-grid">
          @for (materia of item.materias; track materia.materia.id_grupo) {

            <article class="materia-card">
              <header class="materia-header">
                <h4 class="materia-title">
                  {{ materia.materia.nombre_materia }}
                </h4>
                <div class="materia-meta">
                  <span><strong>Clave:</strong> {{ materia.materia.clave_materia }}</span>
                  <span><strong>Grupo:</strong> {{ materia.materia.letra_grupo }}</span>
                </div>
              </header>

              <div class="materia-calificaciones">
                <!-- Parciales existentes -->
                @for (nota of materia.calificaiones; let i = $index; track nota.id_calificacion) {

                  @if (nota.calificacion === null || nota.calificacion === undefined) {
                    <div class="parcial-item parcial-pendiente">
                      <span class="parcial-label">
                        {{
                          i === 0 ? '1er Parcial'
                          : i === 1 ? '2do Parcial'
                          : i === 2 ? '3er Parcial'
                          : '4to Parcial'
                        }}
                      </span>
                      <span class="parcial-score">-</span>
                    </div>
                  }
                  @else {
                    <div
                      class="parcial-item"
                      [ngClass]="nota.calificacion >= 70 ? 'parcial-ok' : 'parcial-bad'"
                    >
                      <span class="parcial-label">
                        {{
                          i === 0 ? '1er Parcial'
                          : i === 1 ? '2do Parcial'
                          : i === 2 ? '3er Parcial'
                          : '4to Parcial'
                        }}
                      </span>
                      <span class="parcial-score">
                        {{ nota.calificacion }}
                      </span>
                    </div>
                  }
                }

                <!-- Relleno hasta 4 parciales -->
                @if (materia.calificaiones.length < 4) {
                  @for (rest of [0,1,2,3].slice(materia.calificaiones.length); let j = $index; track j) {
                    <div class="parcial-item parcial-pendiente">
                      <span class="parcial-label">
                        {{
                          (materia.calificaiones.length + j) === 0 ? '1er Parcial'
                          : (materia.calificaiones.length + j) === 1 ? '2do Parcial'
                          : (materia.calificaiones.length + j) === 2 ? '3er Parcial'
                          : '4to Parcial'
                        }}
                      </span>
                      <span class="parcial-score">-</span>
                    </div>
                  }
                }
              </div>
            </article>

          }
        </div>
      </section>

    }
  }
  @else {
    <p class="grades-empty">No hay calificaciones para mostrar.</p>
  }
</div>
